<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="/assets/css/navbar.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/home.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/about.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/tech.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/index.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/post.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/toc.js"></script>

    <meta charset="utf-8" />
    <title>Blog | Zeyu (Clarence)</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light">
    <a class="navbar-brand" href="/index">
        <img src="/assets/images/signature_en.png" width="auto" height="60px" class="d-inline-block align-top"
            alt="brand_logo">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="/pages/about">About</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/tech/">Tech</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/life/">Life</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/reading/">Reading</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/music/">Music</a>
            </li>
        </ul>
    </div>
</nav> <div class="post">
    <div class="title">
        <h1>How to serve React with Docker and Nginx</h1>
    </div>

    <div class="content-area">
        <div id="toc">
            <div
                style="color:darkgoldenrod; font-weight:bolder; font-size:1.5rem; text-decoration: underline; margin-bottom: 1.2rem;">
                OUTLINE</div>
            <!-- Table of contents will be generated here -->
        </div>
        <div class="blog-content">
            <h1 id="intro">Intro</h1>

<p>This tutorial shows you how to serve your React.js web App with Docker + Nginx, we will also explore securing the website with Https using a trusted CA (Certificate Autority). Are you ready? Let’s go!</p>

<h1 id="dockerfile-without-ssl-firstly">Dockerfile without SSL firstly</h1>

<p>In the frontend (React) root folder, say, the same level as ‘public’, ‘src’, ‘node_modules’, we are going to create a file named ‘Dockerfile’, this file contains the following configuration:</p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="w"> </span><span class="s">node:19-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>
<span class="c"># Set the working directory to /app inside the container</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="c"># Copy app files</span>
<span class="k">COPY</span><span class="s"> . .</span>
<span class="c"># Install dependencies (npm ci makes sure the exact versions in the lockfile gets installed)</span>
<span class="k">RUN </span>npm ci
<span class="c"># Build the app</span>
<span class="k">RUN </span>npm run build

<span class="c"># Bundle static assets with nginx</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">nginx:1.21.0-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">production</span>
<span class="k">ENV</span><span class="s"> NODE_ENV production</span>
<span class="c"># Copy built assets from `builder` image</span>
<span class="k">COPY</span><span class="s"> --from=builder /app/build /usr/share/nginx/html</span>
<span class="c"># Add your nginx.conf</span>
<span class="k">COPY</span><span class="s"> nginx.conf /etc/nginx/conf.d/default.conf</span>
<span class="c"># Expose port only for HTTP</span>
<span class="k">EXPOSE</span><span class="s"> 80</span>
<span class="c"># Start nginx</span>
<span class="k">CMD</span><span class="s"> ["nginx", "-g", "daemon off;"]</span>
</code></pre></div></div>

<p>ps: to avoid the image being huge, we also need a ‘.dockerignore’ file, simply put the two folder names in this file:</p>

<div class="language-bash highlighter-rouge"><div class="highlight"><pre class="highlight"><code>node_modules
build
</code></pre></div></div>

<h1 id="nginx-configuration-for-http-firstly">Nginx Configuration for Http firstly</h1>

<p>Also, at the same level as our ‘Dockerfile’, under React root folder, we gonna create another file called ‘nginx.conf’, this file configures the Nginx server:</p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code>server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name baizeyu.info www.baizeyu.info<span class="p">;</span>

    location / <span class="o">{</span>
        root /usr/share/nginx/html/<span class="p">;</span>
        include /etc/nginx/mime.types<span class="p">;</span>
        try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ /index.html<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>
</code></pre></div></div>

<h1 id="try-to-run-http-version-first">Try to run Http version first</h1>

<p>OK, now we have a basic Dockerfile and nginx config file, let’s build it into image and test it locally.</p>

<ul>
  <li>Open terminal, cd to our React root folder first.</li>
  <li>Then run this command to build a image: <code class="language-plaintext highlighter-rouge">docker build -t react-http .</code>, while ‘react-http’ is the name of the image, oh, don’t forget to start your Docker Desktop first ^-^!</li>
  <li>Check if we’ve successfully built the image using: <code class="language-plaintext highlighter-rouge">docker images | grep react-http</code>.</li>
  <li>If you already got an image, let’s try to run this single image with port forwarding to localhost first: <code class="language-plaintext highlighter-rouge">docker run -p 80:80 react-http</code> .</li>
  <li>After the above command, our react-http App has already started on localhost, go to the browser and enter http://localhost, you should see your React App default index page!</li>
</ul>

<h1 id="want-https">Want Https?</h1>

<p>To enable Https on the site, we need to get a CA signed SSL certificate first, there are many free or paid options you can choose over the Internet, I used <a href="https://zerossl.com/">ZeroSSL</a>. Normally, you will get a zip which contains 3 files (a certificate file with extension .crt, a ca_bundle file with extension .crt, and a private key file with extension .key) from a provider. By the way, ‘certificate.crt’ and ‘private.key’ should be matched, we can check it using <a href="https://www.sslshopper.com/certificate-key-matcher.htmll">this site.</a></p>

<p>Once you’ve got a certificate, we gonna move on:<br />
<strong>- Copy ‘certificate.crt’ and ‘private.key’ files to React root folder.</strong><br />
<strong>- Change Dockerfile into this:</strong></p>

<div class="language-dockerfile highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">FROM</span><span class="w"> </span><span class="s">node:19-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">builder</span>
<span class="c"># Set the working directory to /app inside the container</span>
<span class="k">WORKDIR</span><span class="s"> /app</span>
<span class="c"># Copy app files</span>
<span class="k">COPY</span><span class="s"> . .</span>
<span class="c"># Install dependencies (npm ci makes sure the exact versions in the lockfile gets installed)</span>
<span class="k">RUN </span>npm ci
<span class="c"># Build the app</span>
<span class="k">RUN </span>npm run build

<span class="c"># Bundle static assets with nginx</span>
<span class="k">FROM</span><span class="w"> </span><span class="s">nginx:1.21.0-alpine</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="s">production</span>
<span class="k">ENV</span><span class="s"> NODE_ENV production</span>
<span class="c"># Copy built assets from `builder` image</span>
<span class="k">COPY</span><span class="s"> --from=builder /app/build /usr/share/nginx/html</span>
<span class="c"># Copy SSL certs to container</span>
<span class="k">COPY</span><span class="s"> ./certificate.crt /etc/nginx/certs/certificate.crt</span>
<span class="k">COPY</span><span class="s"> ./private.key /etc/nginx/certs/private.key</span>
<span class="c"># Add your nginx.conf</span>
<span class="k">COPY</span><span class="s"> nginx.conf /etc/nginx/conf.d/default.conf</span>
<span class="c"># Expose port</span>
<span class="k">EXPOSE</span><span class="s"> 80</span>
<span class="k">EXPOSE</span><span class="s"> 443</span>
<span class="c"># Start nginx</span>
<span class="k">CMD</span><span class="s"> ["nginx", "-g", "daemon off;"]</span>
</code></pre></div></div>

<p>As we can see, we copied ‘certificate.crt’ and ‘private.key’ into the image, and exposed port 443 for Https requests, simple right?</p>

<p><strong>- Then change nginx.conf as well:</strong></p>

<div class="language-shell highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="c"># nginx.conf</span>

server <span class="o">{</span>
    listen 443 ssl<span class="p">;</span>
    server_name baizeyu.info www.baizeyu.info<span class="p">;</span>
    ssl_certificate /etc/nginx/certs/certificate.crt<span class="p">;</span>
    ssl_certificate_key /etc/nginx/certs/private.key<span class="p">;</span>

    location / <span class="o">{</span>
        root /usr/share/nginx/html/<span class="p">;</span>
        include /etc/nginx/mime.types<span class="p">;</span>
        try_files <span class="nv">$uri</span> <span class="nv">$uri</span>/ /index.html<span class="p">;</span>
    <span class="o">}</span>
<span class="o">}</span>

server <span class="o">{</span>
    listen 80<span class="p">;</span>
    server_name baizeyu.info www.baizeyu.info<span class="p">;</span>
    <span class="k">return </span>301 https://<span class="nv">$host$request_uri</span><span class="p">;</span>
<span class="o">}</span>
</code></pre></div></div>

<p>This time, port 443 will host the static content, any request to port 80 which is Http, will be redirected to Https. Status code 301 means redirect.</p>

<hr />

<p>Congrats! We are all set by now! try to <strong>build the image again</strong> and <strong>run the image with port forwarding to 443</strong>, you should be fine if you go to https://localhost.</p>

        </div>
    </div>
</div>
</body>

</html>