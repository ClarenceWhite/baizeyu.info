<!DOCTYPE html>
<html>

<head>
    <link rel="stylesheet" type="text/css" href="/assets/css/navbar.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/home.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/about.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/tech.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/index.css" />
    <link rel="stylesheet" type="text/css" href="/assets/css/post.css" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;700&display=swap">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Merriweather:wght@400;700&display=swap">
    <link href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.0/css/bootstrap.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.3/css/all.min.css" />

    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@4.5.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="/assets/js/toc.js"></script>

    <meta charset="utf-8" />
    <title>Blog | Zeyu (Clarence)</title>
</head>

<body>
    <nav class="navbar navbar-expand-lg navbar-light">
    <a class="navbar-brand" href="/index">
        <img src="/assets/images/signature_en.png" width="auto" height="60px" class="d-inline-block align-top"
            alt="brand_logo">
    </a>
    <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarNav"
        aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav ml-auto">
            <li class="nav-item">
                <a class="nav-link" href="/pages/about">About</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/tech/">Tech</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/life/">Life</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/reading/">Reading</a>
            </li>
            <li class="nav-item">
                <a class="nav-link" href="/pages/music/">Music</a>
            </li>
        </ul>
    </div>
</nav> <div class="post">
    <div class="title">
        <h1>Docker Compose</h1>
    </div>

    <div class="content-area">
        <div id="toc">
            <div
                style="color:darkgoldenrod; font-weight:bolder; font-size:1.5rem; text-decoration: underline; margin-bottom: 1.2rem;">
                OUTLINE</div>
            <!-- Table of contents will be generated here -->
        </div>
        <div class="blog-content">
            <h1 id="1-why-compose">1. Why Compose?</h1>

<p>To run a service in a container, you need to use the <code class="language-plaintext highlighter-rouge">docker run</code> command. But what if you want to run multiple services? Should you use one container or multiple containers?</p>

<p>Running multiple services in one container can increase the complexity of the image and goes against Docker’s preference for one container per application. As a result, complex architectures require many containers that are dependent and connected to each other.</p>

<p>This complexity requires a solution, which brings up the issue of container orchestration.</p>

<ul>
  <li>Compose
    <ul>
      <li>Orchestration
        <ul>
          <li>A method for starting and managing multiple containers</li>
          <li>For example: start MySQL first, then Tomcat, and finally Nginx</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>Evolution of Service Architecture
    <ul>
      <li>Monolithic Service Architecture</li>
      <li>Distributed Service Architecture</li>
      <li>Microservice Architecture</li>
      <li>Hyper-microservice Architecture</li>
    </ul>
  </li>
  <li>Container Orchestration Tools
    <ul>
      <li>Docker Machine
        <ul>
          <li>A tool for deploying Docker container engines in virtual machines</li>
        </ul>
      </li>
      <li>Docker Compose
        <ul>
          <li>A tool for defining and running multi-container Docker applications</li>
        </ul>
      </li>
      <li>Docker Swarm
        <ul>
          <li>A tool for batch management and resource scheduling of Docker Hosts</li>
        </ul>
      </li>
      <li>Mesos+Marathon
        <ul>
          <li>Mesos manages and schedules computer computing resources</li>
          <li>Marathon provides service discovery and load balancing functions</li>
        </ul>
      </li>
      <li>Kubernetes
        <ul>
          <li>An open source container orchestration tool developed by Google</li>
        </ul>
      </li>
    </ul>
  </li>
</ul>

<h1 id="2-docker-compose-intro">2. Docker Compose Intro</h1>

<h2 id="21-terms">2.1 Terms</h2>

<ul>
  <li>
    <p>Project: A group of related services that work together to provide an application.</p>
  </li>
  <li>Service: A container or group of containers that perform a specific task as part of the application.</li>
  <li>Container: A standalone package of software that includes everything needed to run an application, and is isolated from other containers to ensure portability and consistency.</li>
</ul>

<h2 id="22-how-it-works-in-brief">2.2 How it works in brief</h2>

<ol>
  <li>Define a Dockerfile: this allows us to build an image anywhere.</li>
  <li>Define a docker-compose.yaml file.</li>
  <li>use <code class="language-plaintext highlighter-rouge">docker-compose up</code> to start an app.</li>
</ol>

<h1 id="3-docker-compose-installation">3. Docker Compose Installation</h1>

<p>During the installation of Docker, I also installed all related tools, including <code class="language-plaintext highlighter-rouge">docker-compose</code>. Therefore, this command is already available on my machine.</p>

<p>If you do not have this command, you can go to the official github release page: https://github.com/docker/compose/releases, find the package under ‘Assets’ that is suitable for your machine, download and install it.</p>

<p>Or you can also follow the official documents: https://docs.docker.com/compose/install/, this might be easier for you.</p>

<h1 id="4-docker-compose-demo">4. Docker Compose Demo</h1>

<p>We are going to follow the official documents (https://docs.docker.com/compose/gettingstarted/) to start a simple redis-flask application on our linux machine.</p>

<h2 id="41-define-the-application-dependencies">4.1 Define the application dependencies</h2>

<p>Create a directory for the project:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>mkdir composetest
cd composetest
</code></pre></div></div>

<p>Create a file called <code class="language-plaintext highlighter-rouge">app.py</code> in your project directory and paste the following code in:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim app.py
----------------
import time
import redis
from flask import Flask

app = Flask(__name__)
cache = redis.Redis(host='redis', port=6379)

def get_hit_count():
    retries = 5
    while True:
        try:
            return cache.incr('hits')
        except redis.exceptions.ConnectionError as exc:
            if retries == 0:
                raise exc
            retries -= 1
            time.sleep(0.5)

@app.route('/')
def hello():
    count = get_hit_count()
    return 'Hello World! I have been seen {} times.\n'.format(count)
</code></pre></div></div>

<p>Create another file called <code class="language-plaintext highlighter-rouge">requirements.txt</code> in your project directory and paste the following code in:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim requirements.txt
----------------------
flask
redis
</code></pre></div></div>

<h2 id="42-create-a-dockerfile">4.2 Create a Dockerfile</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim Dockerfile
--------------------
# syntax=docker/dockerfile:1
FROM python:3.7-alpine
WORKDIR /code
ENV FLASK_APP=app.py
ENV FLASK_RUN_HOST=0.0.0.0
RUN apk add --no-cache gcc musl-dev linux-headers
COPY requirements.txt requirements.txt
RUN pip install -r requirements.txt
EXPOSE 5000
COPY . .
CMD ["flask", "run"]
</code></pre></div></div>

<h2 id="43-define-services-in-a-compose-file">4.3 Define services in a Compose file</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>vim docker-compose.yaml
------------------------
version: "3.9"
services:
  web:
    build: .
    ports:
      - "8000:5000"
  redis:
    image: "redis:alpine"
</code></pre></div></div>

<h2 id="44-build-and-run-your-app-with-compose">4.4 Build and run your app with Compose</h2>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker compose up
-----------------------
[+] Running 3/1
 ✔ Network composetest_default    Created                                                                                                                                  0.1s
 ✔ Container composetest-redis-1  Created                                                                                                                                  0.0s
 ✔ Container composetest-web-1    Created                                                                                                                                  0.0s
Attaching to composetest-redis-1, composetest-web-1
composetest-redis-1  | 1:C 30 Apr 2023 00:31:54.724 # oO0OoO0OoO0Oo Redis is starting oO0OoO0OoO0Oo
composetest-redis-1  | 1:C 30 Apr 2023 00:31:54.724 # Redis version=7.0.11, bits=64, commit=00000000, modified=0, pid=1, just started
composetest-redis-1  | 1:C 30 Apr 2023 00:31:54.724 # Warning: no config file specified, using the default config. In order to specify a config file use redis-server /path/to/redis.conf
composetest-redis-1  | 1:M 30 Apr 2023 00:31:54.725 * monotonic clock: POSIX clock_gettime
composetest-redis-1  | 1:M 30 Apr 2023 00:31:54.725 * Running mode=standalone, port=6379.
composetest-redis-1  | 1:M 30 Apr 2023 00:31:54.725 # Server initialized
composetest-redis-1  | 1:M 30 Apr 2023 00:31:54.725 # WARNING Memory overcommit must be enabled! Without it, a background save or replication may fail under low memory condition. Being disabled, it can can also cause failures without low memory condition, see https://github.com/jemalloc/jemalloc/issues/1328. To fix this issue add 'vm.overcommit_memory = 1' to /etc/sysctl.conf and then reboot or run the command 'sysctl vm.overcommit_memory=1' for this to take effect.
composetest-redis-1  | 1:M 30 Apr 2023 00:31:54.727 * Ready to accept connections
composetest-web-1    |  * Serving Flask app 'app.py'
composetest-web-1    |  * Debug mode: off
composetest-web-1    | WARNING: This is a development server. Do not use it in a production deployment. Use a production WSGI server instead.
composetest-web-1    |  * Running on all addresses (0.0.0.0)
composetest-web-1    |  * Running on http://127.0.0.1:5000
composetest-web-1    |  * Running on http://172.18.0.2:5000
composetest-web-1    | Press CTRL+C to quit
</code></pre></div></div>

<p>Open another terminal and visit:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl localhost:8000
---------------------
Hello World! I have been seen 1 times.
</code></pre></div></div>

<p>Visit again:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>curl localhost:8000
--------------------
Hello World! I have been seen 2 times.
</code></pre></div></div>

<p>Check docker images:</p>

<div class="language-plaintext highlighter-rouge"><div class="highlight"><pre class="highlight"><code>docker image ls
-----------------
REPOSITORY        TAG       IMAGE ID       CREATED         SIZE
composetest-web   latest    a224d19462e3   2 minutes ago   203MB
redis             alpine    d196fde608b2   12 days ago     30.4MB
nginx             latest    9e7e7b26c784   2 weeks ago     135MB
</code></pre></div></div>

<p>Great! This was just a quick and simple demonstration. If you want to learn more, I encourage you to visit the documentation I mentioned earlier at https://docs.docker.com/compose/gettingstarted/. There, you can find complete and detailed information on Docker Compose and its functionality.</p>

        </div>
    </div>
</div>
</body>

</html>